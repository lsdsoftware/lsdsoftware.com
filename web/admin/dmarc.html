<!DOCTYPE html>
<html>
  <head>
    <title>DMARC Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
      .modal-spinner .overlay {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: black;
        opacity: .5;
      }
      .modal-spinner .spinner-holder {
        position: fixed;
        top: 50%;
        left: 50%;
      }
      .modal-spinner .spinner {
        margin-left: -60px;
        margin-top: -60px;
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <script src="//cdnjs.cloudflare.com/ajax/libs/ramda/0.31.3/ramda.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://assets.lsdsoftware.com/lib/databind.js"></script>
    <script>
      const queryString = new URLSearchParams(location.search)
      pass = prompt("Enter password:");
      items = [];
      current = 0
      error = null
      progress = 0
      load()

      async function load() {
        error = null
        progress++
        try {
          const res = await fetch("https://service.lsdsoftware.com/lsdsoftware?capabilities=getDmarcReports-1", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              method: 'getDmarcReports',
              pass
            })
          })
          const emails = await res.json()
          items = R.pipe(
            R.uniqBy(R.prop('hash')),
            R.chain(email => {
              const reports = email.reports
              delete email.reports
              return reports.map(report => ({ email, ...report }))
            })
          )(emails)
          current = 0
        } catch (err) {
          error = err
        } finally {
          progress--
        }
      }

      async function clear() {
        error = null
        progress++
        try {
          const res = await fetch("https://service.lsdsoftware.com/lsdsoftware?capabilities=clearDmarcReports-1", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              method: 'clearDmarcReports',
              pass
            })
          })
          const items = await res.json()
          console.log(items.length, 'records deleted')
          load()
        } catch (err) {
          error = err
        } finally {
          progress--
        }
      }
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="mt-4 d-flex">
        <div class="input-group">
          <button type="button" class="btn btn-primary"
            bind-statement-1="thisElem.disabled = !(#current > 0)"
            bind-event-click="#current--">&#x2b9c;</button>
          <label class="input-group-text">{{#current + 1}} of {{#items.length || 0}}</label>
          <button type="button" class="btn btn-primary"
            bind-statement-1="thisElem.disabled = !(#current + 1 < #items.length)"
            bind-event-click="#current++">&#x2b9e;</button>
        </div>
        <div class="ml-auto text-nowrap">
          <span class="me-2" style="color: red;">{{#error}}</span>
          <button type="button" class="btn btn-secondary"
            bind-event-click="this.load()">&#x21bb;</button>
          <button type="button" class="btn btn-danger"
            bind-event-click="this.clear()">Clear</button>
        </div>
      </div>
      <div bind-repeater-if="#current < #items.length ? 1 : 0"
        bind-var-item="#items[#current]"
        bind-var-fields="Object.keys(#item).sort((a,b) => {
          if (a == 'records') return 1
          if (b == 'records') return -1
          return a.localeCompare(b)
        })">
        <div class="mt-5"
          bind-repeater-i="#fields.length"
          bind-var-field="#fields[#i]"
          bind-var-obj="#item[#field]"
          bind-var-props="#field == 'records' ? Array.from(#obj, (_, i) => i) : Object.keys(#obj)">
          <h4>{{#field}}</h4>
          <table class="table table-sm">
            <thead class="table-dark">
              <tr>
                <th bind-repeater-i="#props.length">{{#props[#i]}}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td bind-statement-1="thisElem.style.whiteSpace = #field == 'records' ? 'pre-wrap' : ''"
                  bind-repeater-i="#props.length">{{JSON.stringify(#obj[#props[#i]], null, 2)}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-spinner" bind-repeater-if="#progress ? 1 : 0">
      <div class="overlay"></div>
      <div class="spinner-holder">
        <div class="spinner"></div>
      </div>
    </div>
  </body>
</html>
